name: Notify on Pull Request

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    notify:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Send Gaggle notification
              uses: actions/github-script@v7
              with:
                  script: |
                      const https = require('https');
                      const groupEmail = process.env.GAGGLE_GROUP_EMAIL;
                      const apiKey = process.env.GAGGLE_API_KEY;
                      const prTitle = '${{ github.event.pull_request.title }}';
                      const prAuthor = '${{ github.event.pull_request.user.login }}';
                      const prBody = '${{ github.event.pull_request.body }}';
                      const prUrl = '${{ github.event.pull_request.html_url }}';

                      const subject = 'New Pull Request: ' + prTitle;
                      const body = 'A new pull request has been submitted to community-notebooks!\n\nTitle: ' + prTitle + '\nAuthor: ' + prAuthor + '\nDescription: ' + prBody + '\n\nView PR: ' + prUrl + '\n\n---\nThis is an automated notification from the community-notebooks repository.';

                      const payload = JSON.stringify({ subject: subject, originalTextBody: body });

                      const options = {
                          hostname: 'api.gaggle.email',
                          port: 443,
                          path: '/api/v3/group/' + encodeURIComponent(groupEmail) + '/message',
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'Content-Length': payload.length,
                              'x-api-key': apiKey,
                              'accept': 'application/json'
                          }
                      };

                      return new Promise((resolve, reject) => {
                          const req = https.request(options, (res) => {
                              let data = '';
                              res.on('data', (chunk) => { data += chunk; });
                              res.on('end', () => {
                                  if (res.statusCode === 200) {
                                      console.log('Gaggle notification sent successfully');
                                      resolve(true);
                                  } else {
                                      reject(new Error('Failed to send notification: ' + res.statusCode + ' ' + data));
                                  }
                              });
                          });
                          req.on('error', (e) => reject(e));
                          req.write(payload);
                          req.end();
                      });
              env:
                  GAGGLE_API_KEY: ${{ secrets.GAGGLE_API_KEY }}
                  GAGGLE_GROUP_EMAIL: ${{ secrets.GAGGLE_GROUP_EMAIL }}
