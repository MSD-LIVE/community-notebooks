name: Notify on Pull Request

on:
    pull_request_target:
        types: [opened, synchronize, reopened]

jobs:
    notify:
        runs-on: ubuntu-latest

        steps:
            - name: Send Gaggle notification
              uses: actions/github-script@v7
              with:
                  script: |
                      const https = require('https');
                      const groupEmail = process.env.GAGGLE_GROUP_EMAIL;
                      const apiKey = process.env.GAGGLE_API_KEY;

                      // Check if secrets are available
                      if (!apiKey || !groupEmail) {
                          console.log('Skipping notification: API key or group email not available (likely from a forked PR)');
                          return;
                      }

                      const prTitle = '${{ github.event.pull_request.title }}';
                      const prAuthor = '${{ github.event.pull_request.user.login }}';
                      const prBody = '${{ github.event.pull_request.body }}';
                      const prUrl = '${{ github.event.pull_request.html_url }}';

                      const subject = 'New Pull Request: ' + prTitle;
                      const htmlBody = '<html><body style="font-family: Arial, sans-serif;">' +
                          '<p><strong>A new pull request has been submitted to community-notebooks!</strong></p>' +
                          '<p><strong>Title:</strong><br>' + prTitle + '</p>' +
                          '<p><strong>Author:</strong><br>' + prAuthor + '</p>' +
                          '<p><strong>Description:</strong><br>' + prBody + '</p>' +
                          '<p><a href="' + prUrl + '">View PR: ' + prUrl + '</a></p>' +
                          '<hr>' +
                          '<p><small>This is an automated notification from the community-notebooks repository.</small></p>' +
                          '</body></html>';

                      const payload = JSON.stringify({ subject: subject, originalHtmlBody: htmlBody });

                      const options = {
                          hostname: 'api.gaggle.email',
                          port: 443,
                          path: '/api/v3/group/' + encodeURIComponent(groupEmail) + '/message',
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'Content-Length': payload.length,
                              'x-api-key': apiKey,
                              'accept': 'application/json'
                          }
                      };

                      return new Promise((resolve, reject) => {
                          const req = https.request(options, (res) => {
                              let data = '';
                              res.on('data', (chunk) => { data += chunk; });
                              res.on('end', () => {
                                  if (res.statusCode === 200) {
                                      console.log('Gaggle notification sent successfully');
                                      resolve(true);
                                  } else {
                                      reject(new Error('Failed to send notification: ' + res.statusCode + ' ' + data));
                                  }
                              });
                          });
                          req.on('error', (e) => reject(e));
                          req.write(payload);
                          req.end();
                      });
              env:
                  GAGGLE_API_KEY: ${{ secrets.GAGGLE_API_KEY }}
                  GAGGLE_GROUP_EMAIL: ${{ secrets.GAGGLE_GROUP_EMAIL }}
